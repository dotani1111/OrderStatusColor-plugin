# 詳細設計書：受注一覧ステータス色分けプラグイン

## 1. システム概要

### 1.1 目的

EC-CUBE 4の受注一覧画面において、各行の背景色を注文ステータスに応じて自動的に色分けする。

### 1.2 動作概要

- 受注一覧画面（`@admin/Order/index.twig`）にJavaScriptを注入
- 各行の`Shipping.id`から`OrderStatus.id`を取得
- `OrderStatus.id`に対応する色を`mtb_order_status_color`テーブルから取得
- 取得した色を透明度0.1で行の背景色として適用

## 2. データベース構造とリレーション

### 2.1 関連テーブル（EC-CUBEデフォルト）

```
dtb_order (受注テーブル)
├── id (受注ID)
├── order_status_id (注文ステータスID) → mtb_order_status.id
└── ...

dtb_shipping (出荷テーブル)
├── id (出荷ID)
├── order_id (受注ID) → dtb_order.id
└── ...

mtb_order_status (注文ステータスマスタ)
├── id (ステータスID)
├── name (ステータス名)
└── ...

mtb_order_status_color (注文ステータス色マスタ)
├── id (ステータスID) → mtb_order_status.id
└── name (色コード: HEX形式、例: #FF6B6B)
```

### 2.2 リレーション（EC-CUBEデフォルト）

```
dtb_shipping (1) ──→ (N) dtb_order
                         │
                         └──→ (1) mtb_order_status
                                    │
                                    └──→ (1) mtb_order_status_color
```

**重要なポイント:**

- 受注一覧画面は実際には「出荷一覧」を表示している
- 1つの`Order`に対して複数の`Shipping`が存在する可能性がある
- 各行は`Shipping`を表し、チェックボックスの`data-id`属性に`Shipping.id`が設定されている
- `Shipping`は`Order`に紐づき、`Order`は`OrderStatus`に紐づく

## 3. 処理フロー

### 3.1 PHP側処理（Event.php）

#### 3.1.1 イベント購読

```php
'@admin/Order/index.twig' => 'onAdminOrderIndex'
```

受注一覧画面のテンプレートイベントを購読。

#### 3.1.2 ステータス色の取得

**ステップ1: mtb_order_status_colorテーブルから色を取得**

```sql
SELECT id, name FROM mtb_order_status_color ORDER BY id
```

- `id`: ステータスID（`mtb_order_status.id`と一致）
- `name`: 色コード（HEX形式、例: `FF6B6B` または `#FF6B6B`）

**処理:**

1. `name`カラムの値が`#`で始まっていない場合は`#`を付与
2. 正規表現 `/^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6})$/` でカラーコードの形式を検証
   - `#RGB`形式（3桁の16進数、例: `#FFF`）
   - `#RRGGBB`形式（6桁の16進数、例: `#FF6B6B`）
3. 有効なカラーコードの場合: `statusColors[statusId] = color` の形式で配列に格納
4. 無効なカラーコードの場合: `statusColors[statusId] = '#999999'` を設定

**ステップ2: デフォルト色の設定**

- `mtb_order_status_color`に色が設定されていないステータス（`name`が`NULL`または空文字）に対して、`#999999`（グレー）を設定
- 無効なカラーコード（正規表現で検証できない値）の場合も、`#999999`（グレー）を設定
- `mtb_order_status_color`テーブルはEC-CUBE 4の標準テーブルのため、存在しない場合はエラーとなる（try-catchは不要）

#### 3.1.3 Shipping.id → OrderStatus.id マッピングの作成

**処理フロー:**

```
1. TemplateEventからOrderエンティティのリストを取得
   - paginationパラメータから取得を試行
   - 取得できない場合はOrdersパラメータから取得

2. 各Orderエンティティに対して:
   a. Order->getOrderStatus() でOrderStatusを取得
   b. OrderStatus->getId() でstatusIdを取得
   c. Order->getShippings() でShippingコレクションを取得
   d. 各Shippingに対して:
      - Shipping->getId() でshippingIdを取得
      - shippingIdToStatusIdMap[shippingId] = statusId を設定
```

**データ構造例:**

```php
$shippingIdToStatusIdMap = [
    865 => 4,  // Shipping.id=865 → OrderStatus.id=4（キャンセル）
    866 => 1,  // Shipping.id=866 → OrderStatus.id=1（新規受付）
    ...
];
```

#### 3.1.4 エラーハンドリング

- Orderの取得・処理時にエラーが発生した場合、ログに記録して処理を継続
- 例外を再スローしない（プラグインで例外を投げるとエラー画面になり、通常業務に支障をきたすため）
- `mtb_order_status_color`と`OrderStatusRepository`はEC-CUBE標準のため、エラーハンドリングは不要

#### 3.1.5 テンプレートへのパラメータ設定

```php
$event->setParameter('statusColors', $statusColors);
$event->setParameter('shippingIdToStatusIdMap', $shippingIdToStatusIdMap);
$event->setParameter('opacity', self::OPACITY);
```

#### 3.1.6 JavaScriptスニペットの注入

```php
$event->addSnippet('@OrderStatusColor42/admin/order_index_script.twig');
```

### 3.2 JavaScript側処理（order_index_script.twig）

#### 3.2.1 データの受け取り（IIFE内で直接定義）

```javascript
(function() {
    'use strict';
    var statusColors = {{ statusColors|json_encode|raw }};
    var shippingIdToStatusIdMap = {{ shippingIdToStatusIdMap|json_encode|raw }};
    var opacity = {{ opacity|json_encode|raw }};
    // ...
})();
```

- グローバル変数を使用せず、IIFE内で直接定義（グローバルスコープの汚染を防止）

#### 3.2.2 DOM要素の取得（チェックボックスのIDから取得）

```javascript
var checkboxes = document.querySelectorAll('input[type="checkbox"][id^="check_"]');
```

- チェックボックスのID（`check_1000`形式）から直接行を取得
- テーブル構造に依存しない方式（EC-CUBE標準仕様の`check_{{ Shipping.id }}`を利用）

#### 3.2.3 各行の処理

**ステップ1: Shipping.idの取得**

```javascript
var checkboxId = checkbox.getAttribute('id');
var shippingId = null;
if (checkboxId && checkboxId.startsWith('check_')) {
    shippingId = parseInt(checkboxId.substring(6), 10); // 'check_'.length = 6
}
// data-id属性もフォールバックとして確認
if (!shippingId) {
    shippingId = parseInt(checkbox.getAttribute('data-id'), 10);
}
```

- チェックボックスのID（`check_{{ Shipping.id }}`）から`Shipping.id`を抽出
- `data-id`属性もフォールバックとして使用

**ステップ2: 行要素（tr）の取得**

```javascript
var row = checkbox.closest('tr');
// 古いブラウザ対応
if (!row && checkbox.parentElement) {
    var parent = checkbox.parentElement;
    while (parent && parent.tagName !== 'TR') {
        parent = parent.parentElement;
    }
    row = parent;
}
```

- チェックボックスから親要素（`tr`）を取得
- `closest()`が使えない古いブラウザにも対応

**ステップ3: OrderStatus.idの取得**

```javascript
var statusId = null;
if (shippingIdToStatusIdMap && shippingIdToStatusIdMap[shippingId]) {
    statusId = shippingIdToStatusIdMap[shippingId];
}
```

- `shippingIdToStatusIdMap`を使用して`OrderStatus.id`を取得

**ステップ4: 色の取得**

```javascript
if (statusId && statusColors[statusId]) {
    var color = statusColors[statusId];
    // ...
}
```

- `statusColors`配列から対応する色コード（HEX形式）を取得

**ステップ5: HEX → RGB変換**

```javascript
function hexToRgb(hex) {
    hex = hex.replace('#', '');
    // 3桁の場合は6桁に変換（例: #FFF → #FFFFFF）
    if (hex.length === 3) {
        hex = hex.split('').map(function(char) {
            return char + char;
        }).join('');
    }
    var result = /^([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
    } : null;
}
```

**ステップ6: スタイルの適用（既存スタイルを保持）**

```javascript
// 既存のスタイルを取得
var existingStyle = row.getAttribute('style') || '';
var newStyleValue = '--bs-table-accent-bg: rgba(R, G, B, 0.1);';

// 既存の--bs-table-accent-bgを削除（存在する場合）
var updatedStyle = existingStyle.replace(/--bs-table-accent-bg:\s*[^;]+;?\s*/g, '');

// 既存のスタイルを整理してから新しいスタイルを追加
updatedStyle = updatedStyle.trim();
if (updatedStyle && !updatedStyle.endsWith(';')) {
    updatedStyle += '; ';
} else if (updatedStyle) {
    updatedStyle += ' ';
}
row.setAttribute('style', updatedStyle + newStyleValue);
```

- Bootstrap 5のCSS変数`--bs-table-accent-bg`を使用
- 既存のスタイルを保持しつつ、背景色のみを追加/更新（他のプラグインとの競合回避）

#### 3.2.4 実行タイミング

**初期実行:**

- `DOMContentLoaded`イベントで実行（100ms遅延）
- 既に読み込み済みの場合は500ms遅延で実行

**注意事項:**

- EC-CUBE標準では、AJAXで行が動的に追加されることはない（ページネーションでページ遷移するため）
- カスタマイズ環境でAJAXで行が動的に追加される場合は、色が適用されない可能性がある（そのような環境は稀）

## 4. データマッピング詳細

### 4.1 データフロー図

```
【データベース】
┌─────────────────────┐
│ dtb_shipping        │
│ id: 865             │──┐
│ order_id: 100       │  │
└─────────────────────┘  │
                         │ getShippings()
                         │
                         ▼
┌─────────────────────┐  │
│ dtb_order           │  │
│ id: 100             │◄─┘
│ order_status_id: 4  │──┐
└─────────────────────┘  │
                         │ getOrderStatus()
                         │
                         ▼
┌─────────────────────┐  │
│ mtb_order_status    │  │
│ id: 4               │◄─┘
│ name: キャンセル     │
└─────────────────────┘
         │
         │ idで結合
         ▼
┌─────────────────────┐
│ mtb_order_status_   │
│   color             │
│ id: 4               │
│ name: #95A5A6        │
└─────────────────────┘

【PHP処理】
Shipping.id (865) → OrderStatus.id (4) → Color (#95A5A6)
         │                    │                    │
         └────────────────────┴────────────────────┘
                    shippingIdToStatusIdMap
                    statusColors

【JavaScript処理】
HTML: <input data-id="865">
         │
         ▼
shippingId = 865
         │
         ▼
statusId = shippingIdToStatusIdMap[865] = 4
         │
         ▼
color = statusColors[4] = "#95A5A6"
         │
         ▼
rgb = hexToRgb("#95A5A6") = {r: 149, g: 165, b: 166}
         │
         ▼
style = "--bs-table-accent-bg: rgba(149, 165, 166, 0.1);"
         │
         ▼
<tr style="--bs-table-accent-bg: rgba(149, 165, 166, 0.1);">
```

### 4.2 マッピングテーブル

| Shipping.id | Order.id | OrderStatus.id | OrderStatus.name | Color (HEX) | Color (RGB) |
|------------|----------|----------------|------------------|-------------|-------------|
| 865        | 100      | 4              | キャンセル        | #95A5A6     | 149,165,166 |
| 866        | 101      | 1              | 新規受付          | #FF6B6B     | 255,107,107 |
| 867        | 102      | 6              | 発送済み          | #4A90E2     | 74,144,226  |

## 5. エラーハンドリング

### 5.1 PHP側

**mtb_order_status_colorテーブルが存在しない場合:**

- `mtb_order_status_color`テーブルはEC-CUBE 4の標準テーブルのため、存在しない場合はEC-CUBE自体が動作しない
- エラーハンドリングは不要

**OrderStatusRepositoryの取得エラー:**

- `OrderStatusRepository`はEC-CUBE標準のため、エラーになることは稀
- エラーハンドリングは不要

**Orderの取得・処理エラー:**

- Orderの取得に失敗した場合、ログに記録して処理を継続
- 個別のOrder処理でエラーが発生した場合、ログに記録して`continue`で処理を継続
- **例外を再スローしない**（プラグインで例外を投げるとエラー画面になり、通常業務に支障をきたすため）

**色が設定されていないステータス:**

- `mtb_order_status_color`の`name`カラムが`NULL`または空文字の場合、`#999999`（グレー）を使用
- 無効なカラーコード（正規表現で検証できない値）の場合も、`#999999`（グレー）を使用

**Orderエンティティのメソッドが存在しない場合:**

- `method_exists()`でチェック
- メソッドが存在しない場合はスキップ

### 5.2 JavaScript側

**データが未定義の場合:**

```javascript
if (!statusColors || typeof opacity === 'undefined') {
    console.warn('OrderStatusColor42: ステータス色データが定義されていません');
    return;
}
```

**Shipping.idが取得できない場合:**

- チェックボックスのIDが取得できない場合はスキップ
- `data-id`属性もフォールバックとして確認
- 色が適用されないが、エラーは発生しない

**行要素（tr）が取得できない場合:**

- `closest('tr')`で取得できない場合はスキップ
- 古いブラウザ対応として親要素を遡る処理も実装

**色が取得できない場合:**

- `statusColors[statusId]`が`undefined`の場合はスキップ
- エラーは発生せず、その行は色が適用されない

## 6. 技術的な詳細

### 6.1 使用技術

**PHP:**

- Symfony Event Dispatcher (`EventSubscriberInterface`)
- Doctrine ORM (`EntityManagerInterface`)
- Twig Template Engine

**JavaScript:**

- ネイティブDOM API (`querySelector`, `setAttribute`, `closest`)
- IIFE（即時実行関数式）によるスコープ分離
- Bootstrap 5 CSS変数 (`--bs-table-accent-bg`)

### 6.2 パフォーマンス考慮事項

**PHP側:**

- テンプレートイベントから取得できる`Order`エンティティのみを処理
- ページネーションで表示されているデータのみをマッピング作成
- 不要なデータベースクエリを避ける

**JavaScript側:**

- `querySelectorAll`で一度に全チェックボックスを取得
- `forEach`でループ処理
- チェックボックスのIDから直接行を取得（テーブル構造に依存しない）

### 6.3 競合回避

- PHPテンプレートの直接変更は行わない（競合リスク回避）
- JavaScriptによるDOM操作のみで実現
- グローバル変数を使用しない（IIFEでスコープを分離）
- 既存のスタイルを保持しつつ背景色を追加（他のプラグインとの競合回避）
- Bootstrap 5のCSS変数を使用することで、既存のスタイルとの競合を最小化

### 6.4 カスタマイズ対応

- `mtb_order_status_color`テーブルから色を取得するため、カスタマイズで追加されたステータスにも自動的に対応
- デフォルト色マッピングにより、色が設定されていないステータスにも対応

## 7. ファイル構成

```
OrderStatusColor42/
├── Event.php                                    # イベントサブスクライバー
│   └── onAdminOrderIndex()                      # メイン処理
├── Resource/
│   └── template/
│       └── admin/
│           └── order_index_script.twig          # JavaScriptコード
│               ├── データ受け取り部分（IIFE内で直接定義）
│               ├── hexToRgb()関数
│               ├── applyStatusColors()関数
│               └── DOMContentLoaded時の実行処理
└── doc/
    ├── プラグイン仕様書.md
    └── 詳細設計書.md（本ファイル）
```

## 8. 処理の流れ（時系列）

### 8.1 ページ読み込み時

```
1. EC-CUBE 4が受注一覧画面をレンダリング
   ↓
2. TemplateEvent '@admin/Order/index.twig' が発火
   ↓
3. Event::onAdminOrderIndex() が実行
   ↓
4. mtb_order_status_colorテーブルから色を取得
   ↓
5. TemplateEventからOrderエンティティを取得
   ↓
6. Shipping.id → OrderStatus.id マッピングを作成
   ↓
7. パラメータをテンプレートに設定
   ↓
8. order_index_script.twig をスニペットとして追加
   ↓
9. Twigテンプレートがレンダリングされ、JavaScriptがHTMLに埋め込まれる
   ↓
10. ブラウザがHTMLを解析
    ↓
11. DOMContentLoaded イベント発火
    ↓
12. applyStatusColors() が実行（100ms遅延）
    ↓
13. 各行の背景色が適用される
```

**注意事項:**

- EC-CUBE標準では、AJAXで行が動的に追加されることはない（ページネーションでページ遷移するため）
- カスタマイズ環境でAJAXで行が動的に追加される場合は、色が適用されない可能性がある（そのような環境は稀）

## 9. デフォルト色について

**色の取得優先順位:**

1. **最優先**: `mtb_order_status_color`テーブルの`name`カラムに設定されている有効なカラーコード
   - 有効な形式: `#RGB`（3桁）または `#RRGGBB`（6桁）の16進数
   - 正規表現: `/^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6})$/`
2. **フォールバック**: 以下の場合、`#999999`（グレー）を使用
   - `name`が`NULL`または空文字の場合
   - カラーコードの形式が無効な場合（正規表現で検証できない値）

**注意事項:**

- `mtb_order_status_color`テーブルはEC-CUBE 4の標準テーブルのため、存在しない場合はエラーとなる
- ハードコードされたデフォルト色マッピングは使用しない（シンプルな実装を優先）
- 色が設定されていないステータスはすべて`#999999`（グレー）で表示される

## 10. 今後の拡張可能性

### 10.1 設定画面の追加

- 透明度の調整機能
- カスタム色の設定機能

### 10.2 パフォーマンス改善

- キャッシュ機能の追加
- 大量データ対応の最適化

### 10.3 機能拡張

- ステータスごとの透明度設定
- アニメーション効果の追加
- エクスポート機能（色設定のエクスポート/インポート）

## 11. 注意事項

1. **Shipping.idとOrder.idの関係**
   - 受注一覧画面は実際には「出荷一覧」を表示している
   - 1つのOrderに対して複数のShippingが存在する可能性がある
   - 各行はShippingを表し、同じOrderでも複数行になる場合がある

2. **mtb_order_status_colorテーブルの構造**
   - 色の値は`color`カラムではなく`name`カラムに格納されている
   - HEX形式で格納されているが、`#`の有無は不定

3. **透明度の固定値**
   - 現在は0.1（10%）で固定
   - 設定画面は実装していないため、変更不可

4. **Bootstrap 5のCSS変数**
   - `--bs-table-accent-bg`を使用することで、Bootstrapの既存スタイルと統合
   - `!important`を使用せずに、適切な優先度でスタイルが適用される

