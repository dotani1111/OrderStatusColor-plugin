# プラグイン仕様書：受注一覧ステータス色分けプラグイン

## 1. 基本情報

| 項目 | 内容 |
| --- | --- |
| **プラグイン名称** | 受注一覧ステータス色分けプラグイン |
| **プラグインコード** | `OrderStatusColor42` |
| **対応バージョン** | EC-CUBE 4.2.x 〜 4.3.x |
| **販売価格** | 1,000円 または 無料（想定） |
| **ライセンス** | LGPL または 独自ライセンス |
| **キャッチコピー** | インストールするだけ。受注一覧の行背景色をステータスごとに自動で色分けし、視認性を劇的に向上させます。 |

## 2. 開発背景・目的

### 2.1 現状の課題

EC-CUBE4の標準管理画面では、受注一覧の各行が白背景で統一されており、ステータス（「新規受付」「入金済み」「発送済み」など）の判別は小さなバッジ（ラベル）の文字色でしか判断できない。これにより、配送漏れや入金確認漏れなどのオペレーションミスが発生しやすい。

### 2.2 本プラグインの解決策

各ステータスに設定されているカラーコード（`mtb_order_status_color`）を利用し、**受注一覧の行（`<tr>`）全体の背景色**を変更する。
原色では文字が読みにくくなるため、**固定透明度（Opacity: 0.1）**で視認性を損なわないパステルカラー調のハイライトを実現する。
設定不要で、インストールするだけで自動的に動作する。

## 3. 機能要件

### 3.1 フロント（管理画面・受注一覧）

* **機能:** 受注一覧テーブル（`table.table-striped`）の行背景色を、その受注データのステータス色に変更する。
* **ロジック:**
  * JSによりDOM操作を行い、各行に対応するステータス色を適用する（競合回避のためPHPテンプレート置換は行わない）。
  * 適用する色は、ステータスのHEX値（#RRGGBB）をRGBに変換し、固定透明度（0.1）を掛け合わせた `rgba()` 値とする。
* **スマホ対応:** レスポンシブ表示時も同様に背景色が適用されること。

### 3.2 管理画面（プラグイン設定）

* **設定画面:** なし（設定不要）
* **透明度:** 固定値 `0.1` (10%)

### 3.3 データ・DB関連

* **DB変更:** なし（既存テーブルの追加・変更は行わない）。
* **コンフィグ保存:** なし（設定不要のため）。
* **参照データ:** `mtb_order_status_color` (存在しない場合は `mtb_order_status` とのハードコードマッピングを使用)。

## 4. 技術仕様（実装方針）

### 4.1 ディレクトリ構成

```
OrderStatusColor42/
├── Event.php                    # JS注入用イベントサブスクライバー
├── Resource/
│   └── template/
│       └── admin/
│           └── order_index_script.twig # 行着色ロジック（JavaScript）
└── composer.json
```

### 4.2 アルゴリズム（JavaScriptロジック概要）

1. **データ受取:** Twig（`Event.php`）から `mtb_order_status_color` の一覧（IDとHEX色）、`Shipping.id → OrderStatus.id` のマッピング、固定透明度（0.1）をJSON形式でJS変数に渡す（IIFE内で直接定義し、グローバル変数を使用しない）。
2. **DOM解析:** チェックボックスのID（`check_1000`形式）から直接行を取得する方式を使用（テーブル構造に依存しない）。
3. **ステータス特定:** 
   - チェックボックスのID（`check_{{ Shipping.id }}`）から`Shipping.id`を抽出
   - `Shipping.id → OrderStatus.id` のマッピングを使用してステータスIDを取得
   - チェックボックスから親要素（`tr`）を取得
4. **スタイル適用:** 既存のスタイルを保持しつつ、`--bs-table-accent-bg: rgba(R, G, B, 0.1)` を追加/更新する。

## 5. UI/UX デザイン

### 5.1 受注一覧画面

* 文字色（黒/グレー）は変更せず、背景色のみ淡く色付けることで、可読性を担保する。
* 偶数行・奇数行のストライプ（`table-striped`）よりも、ステータス色が優先して表示されるようにする（CSS `!important` 相当）。

## 6. テスト項目

1. **インストール/削除:** 正常に有効化・削除ができるか。
2. **表示確認:**
   * 全ステータス（新規受付〜完了、キャンセル等）で正しい色が反映されるか。
   * 透明度が固定値 `0.1` で適用されているか。
   * カスタマイズで追加されたステータスでも正しく色が反映されるか。
3. **ブラウザ互換:** Chrome, Firefox, Safari, Edge で動作するか。
4. **スマホ表示:** スマホ幅にした際に崩れがないか、色はついているか。
5. **競合確認:** 他のプラグイン（特に帳票系や一覧カスタマイズ系）を入れた状態でJSエラーが出ないか。

## 7. 実装状況

* ✅ プロトタイプ実装完了（設定画面なし、固定透明度0.1）
* ✅ `mtb_order_status_color` テーブルから色を取得
* ✅ `Shipping.id → OrderStatus.id` のマッピングを使用
* ✅ Bootstrap 5のCSS変数 `--bs-table-accent-bg` を使用
* ✅ チェックボックスのIDから直接行を取得する方式（テーブル構造に依存しない）
* ✅ 既存のスタイルを保持しつつ背景色を追加（他のプラグインとの競合回避）
* ✅ グローバル変数を使用しない実装（IIFEでスコープを分離）
* ✅ エラーハンドリング（PHP側でログ記録、例外を再スローしない）

